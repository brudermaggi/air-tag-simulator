name: Security Scan Pipeline
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ] 
  workflow_dispatch:  
permissions:
  contents: read
jobs:
  bandit:
      name: Run Bandit Security Check
      runs-on: ubuntu-latest
  
      steps:
        - name: Checkout Repository
          uses: actions/checkout@v4
  
        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: '3.x'
  
        - name: Install Bandit
          run: |
            python -m pip install --upgrade pip
            pip install bandit
  
        - name:  Run Bandit with Logging
          run: |
            echo "Running Bandit static code analysis..."
            bandit -r . -x tests -f txt -ll | tee bandit-output.txt
            echo ""
            echo "----- Bandit Issues Found (if any) -----"
            cat bandit-output.txt
  
        - name: ❌ Fail if Bandit finds issues
          run: |
            bandit -r . -x tests -f json -o bandit-result.json -ll
            issues=$(jq '.results | length' bandit-result.json)
            if [ "$issues" -gt 0 ]; then
              echo "❗ Bandit found $issues issue(s). Failing the build."
              exit 1
            else
              echo "✅ No issues found by Bandit."
            fi
  
  
  dependency-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Find all requirements.txt files
        id: check-requirements
        run: |
          echo "Searching for requirements.txt files in the repository..."
          REQUIREMENTS_FILES=$(find . -type f -name "requirements.txt")
          if [ -z "$REQUIREMENTS_FILES" ]; then
            echo "No requirements.txt files found in the repository"
            echo "exists=false" >> $GITHUB_OUTPUT
          else
            echo "Found requirements.txt files:"
            echo "$REQUIREMENTS_FILES"
            echo "exists=true" >> $GITHUB_OUTPUT
            COUNT=$(echo "$REQUIREMENTS_FILES" | wc -l)
            echo "count=$COUNT" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup Python
        if: steps.check-requirements.outputs.exists == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install Python dependencies from all requirements.txt
        if: steps.check-requirements.outputs.exists == 'true'
        continue-on-error: true
        run: |
          python -m pip install --upgrade pip
          echo "Installing dependencies from all requirements.txt files..."
          while IFS= read -r req_file; do
            echo "----------------------------------------"
            echo "Processing: $req_file"
            if pip install -r "$req_file"; then
              echo " Successfully installed dependencies from $req_file"
            else
              echo " Warning: Failed to install some dependencies from $req_file"
            fi
            echo ""
          done < <(find . -type f -name "requirements.txt")
      
      - name: Run OWASP Dependency-Check (Action)
        if: steps.check-requirements.outputs.exists == 'true'
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'unsicheres-projekt-mit-bekannt'
          format: 'ALL'
          outputDirectory: 'reports'
          scan: '.'
      
      - name: Upload Dependency-Check Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-reports
          path: reports/
          retention-days: 30
      
      - name: Display Dependency Check Summary
        if: steps.check-requirements.outputs.exists == 'true'
        run: |
          echo "# Dependency Check Summary"
          if [ -f "reports/dependency-check-report.json" ]; then
            echo "Report generated successfully"
            echo "Check the uploaded artifacts for detailed results"
          else
            echo "  Report may not have been generated"
          fi
